<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 피드백 보드 - HTHT×SEL 프로젝트</title>
    <meta name="description" content="모둠별 프로젝트에 대한 실시간 피드백을 주고받을 수 있는 협력 도구">
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="common.css">
    
    <style>
        .main-content {
            padding: var(--spacing-xl) 0;
            min-height: calc(100vh - 200px);
        }

        .page-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .page-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto var(--spacing-lg);
            line-height: 1.6;
        }

        /* 컨트롤 패널 */
        .control-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .control-row {
            display: flex;
            gap: var(--spacing-lg);
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: var(--spacing-lg);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .control-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .control-input {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            min-width: 150px;
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .room-info {
            background: var(--bg-gradient-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-left: auto;
        }

        .room-code {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        /* 피드백 입력 영역 */
        .feedback-input-section {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .feedback-form {
            display: grid;
            gap: var(--spacing-lg);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .feedback-type-selector {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .feedback-type-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--bg-tertiary);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.9rem;
        }

        .feedback-type-btn:hover {
            border-color: var(--primary-color);
        }

        .feedback-type-btn.active {
            background: var(--bg-gradient);
            color: var(--text-white);
            border-color: var(--primary-color);
        }

        /* 피드백 보드 */
        .feedback-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .feedback-column {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .column-header {
            padding: var(--spacing-lg);
            background: var(--bg-gradient);
            color: var(--text-white);
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .column-content {
            padding: var(--spacing-lg);
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }

        .feedback-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition-normal);
            animation: slideIn 0.3s ease-out;
        }

        .feedback-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .feedback-card.positive {
            border-left-color: var(--success-color);
        }

        .feedback-card.constructive {
            border-left-color: var(--warning-color);
        }

        .feedback-card.question {
            border-left-color: var(--info-color);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .feedback-author {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .feedback-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .feedback-type-badge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .feedback-type-badge.positive {
            background: rgba(72, 187, 120, 0.2);
            color: var(--success-color);
        }

        .feedback-type-badge.constructive {
            background: rgba(237, 137, 54, 0.2);
            color: var(--warning-color);
        }

        .feedback-type-badge.question {
            background: rgba(66, 153, 225, 0.2);
            color: var(--info-color);
        }

        .feedback-content {
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: var(--spacing-sm);
        }

        .feedback-target {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
        }

        .feedback-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .feedback-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
            font-size: 0.8rem;
        }

        .feedback-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .feedback-action-btn.liked {
            color: var(--primary-color);
        }

        /* 통계 패널 */
        .stats-panel {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-lg);
        }

        .stat-item {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .room-info {
                margin-left: 0;
                justify-content: center;
            }

            .feedback-board {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: var(--spacing-2xl);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <!-- 네비게이션은 common.js에서 자동 생성됩니다 -->

    <main class="main-content">
        <div class="container">
            <!-- 페이지 헤더 -->
            <div class="page-header">
                <h1 class="page-title">실시간 피드백 보드</h1>
                <p class="page-subtitle">
                    모둠별 프로젝트에 대한 실시간 피드백을 주고받으며 협력적 학습을 경험해보세요
                </p>
            </div>

            <!-- 컨트롤 패널 -->
            <div class="control-panel">
                <div class="control-row">
                    <div class="control-group">
                        <label class="control-label">참여자 이름</label>
                        <input type="text" class="control-input" id="userName" placeholder="이름을 입력하세요">
                    </div>
                    <div class="control-group">
                        <label class="control-label">모둠명</label>
                        <input type="text" class="control-input" id="teamName" placeholder="모둠명을 입력하세요">
                    </div>
                    <div class="control-group">
                        <label class="control-label">세션 코드</label>
                        <input type="text" class="control-input" id="sessionCode" placeholder="세션 코드 (선택사항)">
                    </div>
                    <div class="room-info">
                        <i class="fas fa-users"></i>
                        <span>방 코드: <span class="room-code" id="roomCode">HTHT2024</span></span>
                    </div>
                </div>
            </div>

            <!-- 피드백 입력 섹션 -->
            <div class="feedback-input-section">
                <h2 style="margin-bottom: var(--spacing-lg); color: var(--text-primary);">
                    <i class="fas fa-comment-dots"></i> 피드백 작성하기
                </h2>
                
                <form class="feedback-form" id="feedbackForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">대상 모둠</label>
                            <select class="form-select" id="targetTeam" required>
                                <option value="">모둠을 선택하세요</option>
                                <option value="1모둠">1모둠</option>
                                <option value="2모둠">2모둠</option>
                                <option value="3모둠">3모둠</option>
                                <option value="4모둠">4모둠</option>
                                <option value="5모둠">5모둠</option>
                                <option value="전체">전체</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">피드백 유형</label>
                            <div class="feedback-type-selector">
                                <button type="button" class="feedback-type-btn active" data-type="positive">
                                    <i class="fas fa-thumbs-up"></i> 긍정적
                                </button>
                                <button type="button" class="feedback-type-btn" data-type="constructive">
                                    <i class="fas fa-lightbulb"></i> 개선 제안
                                </button>
                                <button type="button" class="feedback-type-btn" data-type="question">
                                    <i class="fas fa-question-circle"></i> 질문
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">피드백 내용</label>
                        <textarea class="form-textarea" id="feedbackContent" 
                                placeholder="구체적이고 건설적인 피드백을 작성해주세요..." required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">SEL 역량 연계</label>
                            <select class="form-select" id="selCompetency">
                                <option value="">관련 SEL 역량 (선택사항)</option>
                                <option value="selfAwareness">✪ 자기인식</option>
                                <option value="selfManagement">♢ 자기관리</option>
                                <option value="socialAwareness">♧ 사회적 인식</option>
                                <option value="relationshipSkills">♤ 관계 기술</option>
                                <option value="responsibleDecision">★ 책임 있는 의사결정</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-paper-plane"></i>
                                피드백 전송
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 통계 패널 -->
            <div class="stats-panel">
                <h2 style="text-align: center; margin-bottom: var(--spacing-lg); color: var(--text-primary);">
                    📊 실시간 통계
                </h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number" id="totalFeedbacks">0</span>
                        <div class="stat-label">총 피드백</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="positiveFeedbacks">0</span>
                        <div class="stat-label">긍정적 피드백</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="constructiveFeedbacks">0</span>
                        <div class="stat-label">개선 제안</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="questionFeedbacks">0</span>
                        <div class="stat-label">질문</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="activeParticipants">0</span>
                        <div class="stat-label">참여자</div>
                    </div>
                </div>
            </div>

            <!-- 피드백 보드 -->
            <div class="feedback-board">
                <div class="feedback-column">
                    <div class="column-header">
                        <i class="fas fa-thumbs-up"></i>
                        긍정적 피드백
                    </div>
                    <div class="column-content" id="positiveFeedbackColumn">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="empty-text">아직 긍정적 피드백이 없습니다</div>
                        </div>
                    </div>
                </div>

                <div class="feedback-column">
                    <div class="column-header">
                        <i class="fas fa-lightbulb"></i>
                        개선 제안
                    </div>
                    <div class="column-content" id="constructiveFeedbackColumn">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="empty-text">아직 개선 제안이 없습니다</div>
                        </div>
                    </div>
                </div>

                <div class="feedback-column">
                    <div class="column-header">
                        <i class="fas fa-question-circle"></i>
                        질문
                    </div>
                    <div class="column-content" id="questionFeedbackColumn">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="empty-text">아직 질문이 없습니다</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 액션 버튼 -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="clearBoard()">
                    <i class="fas fa-eraser"></i>
                    보드 초기화
                </button>
                <button class="btn btn-outline" onclick="exportFeedbacks()">
                    <i class="fas fa-download"></i>
                    피드백 내보내기
                </button>
                <button class="btn btn-outline" onclick="generateReport()">
                    <i class="fas fa-chart-bar"></i>
                    분석 리포트
                </button>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="common.js"></script>
    <script>
        class FeedbackBoard {
            constructor() {
                this.feedbacks = [];
                this.participants = new Set();
                this.selectedFeedbackType = 'positive';
                this.init();
            }

            init() {
                this.loadFromStorage();
                this.bindEvents();
                this.updateStats();
                this.renderFeedbacks();
                this.generateRoomCode();
            }

            bindEvents() {
                // 피드백 폼 제출
                document.getElementById('feedbackForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitFeedback();
                });

                // 피드백 유형 선택
                document.querySelectorAll('.feedback-type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.feedback-type-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.selectedFeedbackType = btn.dataset.type;
                    });
                });

                // 자동 저장 (30초마다)
                setInterval(() => {
                    this.autoSave();
                }, 30000);

                // 실시간 업데이트 시뮬레이션 (5초마다)
                setInterval(() => {
                    this.simulateRealTimeUpdate();
                }, 5000);
            }

            generateRoomCode() {
                const codes = ['HTHT2024', 'SEL2024', 'AIDT2024', 'PROJ2024'];
                const roomCode = codes[Math.floor(Math.random() * codes.length)];
                document.getElementById('roomCode').textContent = roomCode;
            }

            submitFeedback() {
                const userName = document.getElementById('userName').value.trim();
                const teamName = document.getElementById('teamName').value.trim();
                const targetTeam = document.getElementById('targetTeam').value;
                const content = document.getElementById('feedbackContent').value.trim();
                const selCompetency = document.getElementById('selCompetency').value;

                if (!userName) {
                    HTHT.Toast.show('참여자 이름을 입력해주세요.', 'warning');
                    return;
                }

                if (!targetTeam) {
                    HTHT.Toast.show('대상 모둠을 선택해주세요.', 'warning');
                    return;
                }

                if (!content) {
                    HTHT.Toast.show('피드백 내용을 입력해주세요.', 'warning');
                    return;
                }

                const feedback = {
                    id: Date.now(),
                    author: userName,
                    team: teamName || '미지정',
                    targetTeam: targetTeam,
                    type: this.selectedFeedbackType,
                    content: content,
                    selCompetency: selCompetency,
                    timestamp: new Date(),
                    likes: 0,
                    replies: []
                };

                this.feedbacks.unshift(feedback);
                this.participants.add(userName);
                
                this.renderFeedbacks();
                this.updateStats();
                this.autoSave();

                // 폼 초기화
                document.getElementById('feedbackContent').value = '';
                document.getElementById('selCompetency').value = '';

                HTHT.Toast.show('피드백이 성공적으로 전송되었습니다!', 'success');
            }

            renderFeedbacks() {
                const columns = {
                    positive: document.getElementById('positiveFeedbackColumn'),
                    constructive: document.getElementById('constructiveFeedbackColumn'),
                    question: document.getElementById('questionFeedbackColumn')
                };

                // 각 컬럼 초기화
                Object.values(columns).forEach(column => {
                    column.innerHTML = '';
                });

                // 피드백이 없는 경우 빈 상태 표시
                const feedbacksByType = {
                    positive: this.feedbacks.filter(f => f.type === 'positive'),
                    constructive: this.feedbacks.filter(f => f.type === 'constructive'),
                    question: this.feedbacks.filter(f => f.type === 'question')
                };

                Object.keys(feedbacksByType).forEach(type => {
                    const feedbacks = feedbacksByType[type];
                    const column = columns[type];

                    if (feedbacks.length === 0) {
                        const emptyMessages = {
                            positive: '아직 긍정적 피드백이 없습니다',
                            constructive: '아직 개선 제안이 없습니다',
                            question: '아직 질문이 없습니다'
                        };

                        const emptyIcons = {
                            positive: 'fas fa-heart',
                            constructive: 'fas fa-lightbulb',
                            question: 'fas fa-question-circle'
                        };

                        column.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="${emptyIcons[type]}"></i>
                                </div>
                                <div class="empty-text">${emptyMessages[type]}</div>
                            </div>
                        `;
                    } else {
                        feedbacks.forEach(feedback => {
                            column.appendChild(this.createFeedbackCard(feedback));
                        });
                    }
                });
            }

            createFeedbackCard(feedback) {
                const card = document.createElement('div');
                card.className = `feedback-card ${feedback.type}`;
                
                const selCompetencyText = feedback.selCompetency ? 
                    this.getSelCompetencyText(feedback.selCompetency) : '';

                card.innerHTML = `
                    <div class="feedback-header">
                        <div class="feedback-author">${feedback.author}</div>
                        <div class="feedback-time">${this.formatTime(feedback.timestamp)}</div>
                    </div>
                    <div class="feedback-type-badge ${feedback.type}">
                        ${this.getFeedbackTypeText(feedback.type)}
                    </div>
                    <div class="feedback-content">${feedback.content}</div>
                    <div class="feedback-target">→ ${feedback.targetTeam}</div>
                    ${selCompetencyText ? `<div class="feedback-target">🎯 ${selCompetencyText}</div>` : ''}
                    <div class="feedback-actions">
                        <button class="feedback-action-btn" onclick="likeFeedback(${feedback.id})">
                            <i class="fas fa-thumbs-up"></i> ${feedback.likes}
                        </button>
                        <button class="feedback-action-btn" onclick="replyFeedback(${feedback.id})">
                            <i class="fas fa-reply"></i> 답글
                        </button>
                    </div>
                `;

                return card;
            }

            getFeedbackTypeText(type) {
                const types = {
                    positive: '긍정적',
                    constructive: '개선 제안',
                    question: '질문'
                };
                return types[type] || type;
            }

            getSelCompetencyText(competency) {
                const competencies = {
                    selfAwareness: '✪ 자기인식',
                    selfManagement: '♢ 자기관리',
                    socialAwareness: '♧ 사회적 인식',
                    relationshipSkills: '♤ 관계 기술',
                    responsibleDecision: '★ 책임 있는 의사결정'
                };
                return competencies[competency] || competency;
            }

            formatTime(timestamp) {
                const now = new Date();
                const diff = now - new Date(timestamp);
                const minutes = Math.floor(diff / 60000);
                
                if (minutes < 1) return '방금 전';
                if (minutes < 60) return `${minutes}분 전`;
                
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}시간 전`;
                
                return new Date(timestamp).toLocaleDateString('ko-KR');
            }

            updateStats() {
                const stats = {
                    total: this.feedbacks.length,
                    positive: this.feedbacks.filter(f => f.type === 'positive').length,
                    constructive: this.feedbacks.filter(f => f.type === 'constructive').length,
                    question: this.feedbacks.filter(f => f.type === 'question').length,
                    participants: this.participants.size
                };

                document.getElementById('totalFeedbacks').textContent = stats.total;
                document.getElementById('positiveFeedbacks').textContent = stats.positive;
                document.getElementById('constructiveFeedbacks').textContent = stats.constructive;
                document.getElementById('questionFeedbacks').textContent = stats.question;
                document.getElementById('activeParticipants').textContent = stats.participants;
            }

            simulateRealTimeUpdate() {
                // 실제 환경에서는 WebSocket이나 Server-Sent Events를 사용
                // 여기서는 데모용으로 가끔 샘플 피드백 추가
                if (Math.random() < 0.1 && this.feedbacks.length < 20) {
                    const sampleFeedbacks = [
                        {
                            author: '김선생',
                            team: '교사',
                            targetTeam: '1모둠',
                            type: 'positive',
                            content: '프레젠테이션이 매우 인상적이었습니다. 특히 데이터 시각화 부분이 뛰어났어요!',
                            selCompetency: 'selfAwareness'
                        },
                        {
                            author: '이학생',
                            team: '2모둠',
                            targetTeam: '3모둠',
                            type: 'constructive',
                            content: '아이디어는 좋지만 실현 가능성에 대한 검토가 더 필요할 것 같습니다.',
                            selCompetency: 'responsibleDecision'
                        },
                        {
                            author: '박학생',
                            team: '4모둠',
                            targetTeam: '5모둠',
                            type: 'question',
                            content: 'AI 모델의 정확도는 어느 정도인가요? 테스트 결과가 궁금합니다.',
                            selCompetency: 'socialAwareness'
                        }
                    ];

                    const sample = sampleFeedbacks[Math.floor(Math.random() * sampleFeedbacks.length)];
                    const feedback = {
                        id: Date.now(),
                        ...sample,
                        timestamp: new Date(),
                        likes: Math.floor(Math.random() * 5),
                        replies: []
                    };

                    this.feedbacks.unshift(feedback);
                    this.participants.add(sample.author);
                    
                    this.renderFeedbacks();
                    this.updateStats();
                }
            }

            likeFeedback(feedbackId) {
                const feedback = this.feedbacks.find(f => f.id === feedbackId);
                if (feedback) {
                    feedback.likes++;
                    this.renderFeedbacks();
                    this.autoSave();
                }
            }

            replyFeedback(feedbackId) {
                const reply = prompt('답글을 입력하세요:');
                if (reply && reply.trim()) {
                    const feedback = this.feedbacks.find(f => f.id === feedbackId);
                    if (feedback) {
                        feedback.replies.push({
                            author: document.getElementById('userName').value || '익명',
                            content: reply.trim(),
                            timestamp: new Date()
                        });
                        this.renderFeedbacks();
                        this.autoSave();
                        HTHT.Toast.show('답글이 추가되었습니다.', 'success');
                    }
                }
            }

            clearBoard() {
                if (confirm('모든 피드백을 삭제하시겠습니까?')) {
                    this.feedbacks = [];
                    this.participants.clear();
                    this.renderFeedbacks();
                    this.updateStats();
                    HTHT.Toast.show('피드백 보드가 초기화되었습니다.', 'info');
                }
            }

            exportFeedbacks() {
                const exportData = {
                    title: '실시간 피드백 보드 데이터',
                    timestamp: new Date().toISOString(),
                    roomCode: document.getElementById('roomCode').textContent,
                    feedbacks: this.feedbacks,
                    participants: Array.from(this.participants),
                    stats: {
                        total: this.feedbacks.length,
                        positive: this.feedbacks.filter(f => f.type === 'positive').length,
                        constructive: this.feedbacks.filter(f => f.type === 'constructive').length,
                        question: this.feedbacks.filter(f => f.type === 'question').length,
                        participants: this.participants.size
                    }
                };

                HTHT.ExportManager.downloadJSON(exportData, `피드백보드_${new Date().toISOString().split('T')[0]}`);
                HTHT.Toast.show('피드백 데이터가 내보내졌습니다.', 'success');
            }

            generateReport() {
                const report = this.createAnalysisReport();
                HTHT.ExportManager.downloadText(report, `피드백분석리포트_${new Date().toISOString().split('T')[0]}`);
                HTHT.Toast.show('분석 리포트가 생성되었습니다.', 'success');
            }

            createAnalysisReport() {
                const stats = {
                    total: this.feedbacks.length,
                    positive: this.feedbacks.filter(f => f.type === 'positive').length,
                    constructive: this.feedbacks.filter(f => f.type === 'constructive').length,
                    question: this.feedbacks.filter(f => f.type === 'question').length
                };

                const teamStats = {};
                this.feedbacks.forEach(feedback => {
                    if (!teamStats[feedback.targetTeam]) {
                        teamStats[feedback.targetTeam] = { positive: 0, constructive: 0, question: 0 };
                    }
                    teamStats[feedback.targetTeam][feedback.type]++;
                });

                return `
# 실시간 피드백 보드 분석 리포트

생성일시: ${new Date().toLocaleString('ko-KR')}
방 코드: ${document.getElementById('roomCode').textContent}

## 전체 통계

- 총 피드백 수: ${stats.total}개
- 긍정적 피드백: ${stats.positive}개 (${Math.round(stats.positive/stats.total*100) || 0}%)
- 개선 제안: ${stats.constructive}개 (${Math.round(stats.constructive/stats.total*100) || 0}%)
- 질문: ${stats.question}개 (${Math.round(stats.question/stats.total*100) || 0}%)
- 참여자 수: ${this.participants.size}명

## 모둠별 피드백 현황

${Object.keys(teamStats).map(team => `
### ${team}
- 긍정적 피드백: ${teamStats[team].positive}개
- 개선 제안: ${teamStats[team].constructive}개
- 질문: ${teamStats[team].question}개
- 총 피드백: ${teamStats[team].positive + teamStats[team].constructive + teamStats[team].question}개
`).join('')}

## SEL 역량 연계 분석

${this.analyzeSELCompetencies()}

## 주요 피드백 내용

### 긍정적 피드백 (상위 3개)
${this.getTopFeedbacks('positive').map((f, i) => `${i+1}. "${f.content}" - ${f.author}`).join('\n')}

### 개선 제안 (상위 3개)
${this.getTopFeedbacks('constructive').map((f, i) => `${i+1}. "${f.content}" - ${f.author}`).join('\n')}

### 질문 (상위 3개)
${this.getTopFeedbacks('question').map((f, i) => `${i+1}. "${f.content}" - ${f.author}`).join('\n')}

## 개선 제안

${this.generateImprovementSuggestions()}

---
HTHT×SEL 프로젝트 - 실시간 피드백 보드
                `.trim();
            }

            analyzeSELCompetencies() {
                const selStats = {};
                this.feedbacks.forEach(feedback => {
                    if (feedback.selCompetency) {
                        if (!selStats[feedback.selCompetency]) {
                            selStats[feedback.selCompetency] = 0;
                        }
                        selStats[feedback.selCompetency]++;
                    }
                });

                if (Object.keys(selStats).length === 0) {
                    return '- SEL 역량과 연계된 피드백이 없습니다.';
                }

                return Object.keys(selStats).map(competency => 
                    `- ${this.getSelCompetencyText(competency)}: ${selStats[competency]}개`
                ).join('\n');
            }

            getTopFeedbacks(type) {
                return this.feedbacks
                    .filter(f => f.type === type)
                    .sort((a, b) => b.likes - a.likes)
                    .slice(0, 3);
            }

            generateImprovementSuggestions() {
                const suggestions = [];
                const stats = {
                    positive: this.feedbacks.filter(f => f.type === 'positive').length,
                    constructive: this.feedbacks.filter(f => f.type === 'constructive').length,
                    question: this.feedbacks.filter(f => f.type === 'question').length
                };

                if (stats.positive < stats.constructive) {
                    suggestions.push('- 긍정적 피드백을 더 많이 주고받아 동기부여를 높여보세요.');
                }

                if (stats.question < stats.total * 0.2) {
                    suggestions.push('- 궁금한 점을 더 적극적으로 질문하여 깊이 있는 학습을 해보세요.');
                }

                if (this.participants.size < 5) {
                    suggestions.push('- 더 많은 학생들이 피드백에 참여할 수 있도록 격려해보세요.');
                }

                if (suggestions.length === 0) {
                    suggestions.push('- 현재 피드백 활동이 균형있게 이루어지고 있습니다. 계속 유지해주세요!');
                }

                return suggestions.join('\n');
            }

            autoSave() {
                HTHT.StorageManager.save('feedbackBoard', {
                    feedbacks: this.feedbacks,
                    participants: Array.from(this.participants)
                });
            }

            loadFromStorage() {
                const savedData = HTHT.StorageManager.load('feedbackBoard');
                if (savedData) {
                    this.feedbacks = savedData.feedbacks || [];
                    this.participants = new Set(savedData.participants || []);
                }
            }
        }

        // 전역 함수들
        function likeFeedback(feedbackId) {
            window.feedbackBoard.likeFeedback(feedbackId);
        }

        function replyFeedback(feedbackId) {
            window.feedbackBoard.replyFeedback(feedbackId);
        }

        function clearBoard() {
            window.feedbackBoard.clearBoard();
        }

        function exportFeedbacks() {
            window.feedbackBoard.exportFeedbacks();
        }

        function generateReport() {
            window.feedbackBoard.generateReport();
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            window.feedbackBoard = new FeedbackBoard();
        });
    </script>
</body>
</html>

